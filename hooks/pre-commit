#!/bin/bash
# Pre-commit hook that runs the same checks as the CI workflow

set -e  # Exit on first error

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Helper function to run a check with timing
run_check() {
    local name=$1
    local cmd=$2
    local fix_hint=$3

    echo -e "${YELLOW}${name}${NC}"
    start=$(date +%s)

    # Create temp file for output
    local tmpfile=$(mktemp)

    if eval "$cmd" > "$tmpfile" 2>&1; then
        end=$(date +%s)
        duration=$((end - start))
        echo -e "${GREEN}âœ“ Passed${NC} ${BLUE}(${duration}s)${NC}\n"
        rm -f "$tmpfile"
        return 0
    else
        end=$(date +%s)
        duration=$((end - start))
        echo -e "${RED}âœ— Failed${NC} ${BLUE}(${duration}s)${NC}"
        cat "$tmpfile"
        if [ -n "$fix_hint" ]; then
            echo -e "${YELLOW}ğŸ’¡ Quick fix: ${fix_hint}${NC}"
        fi
        echo ""
        rm -f "$tmpfile"
        exit 1
    fi
}

echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}   Pre-Commit: Running GitHub Workflow Checks${NC}"
echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}\n"

# Check if we're in a virtual environment, if not warn the user
if [ -z "$VIRTUAL_ENV" ]; then
    echo -e "${YELLOW}âš  Warning: Not running in a virtual environment${NC}"
    echo -e "${YELLOW}   Make sure you have all dependencies installed${NC}\n"
fi

# Track total time
total_start=$(date +%s)

# Support for QUICK_MODE environment variable
if [ "${QUICK_MODE:-0}" = "1" ]; then
    echo -e "${BLUE}â„¹ Running in QUICK MODE (format + lint only)${NC}\n"

    run_check "[1/2] Black Format Check" \
        "black --check src/ tests/" \
        "make format"

    run_check "[2/2] Ruff Linting" \
        "ruff check src/ tests/" \
        "make lint-fix"
else
    # Full CI checks
    run_check "[1/5] Black Format Check" \
        "black --check src/ tests/" \
        "make format"

    run_check "[2/5] Ruff Linting" \
        "ruff check src/ tests/" \
        "make lint-fix"

    run_check "[3/5] MyPy Type Check" \
        "python -m mypy src/continuous_wave --strict" \
        ""

    run_check "[4/5] Pytest Coverage" \
        "python -m pytest tests/ -v --cov=continuous_wave --cov-report=term-missing --cov-fail-under=90" \
        ""

    run_check "[5/5] Build Package" \
        "python -m build > /dev/null 2>&1" \
        ""

    # Clean up build artifacts
    rm -rf build/ dist/ *.egg-info
fi

# Calculate total time
total_end=$(date +%s)
total_duration=$((total_end - total_start))

echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}âœ“ All checks passed!${NC} ${BLUE}(Total: ${total_duration}s)${NC}"
if [ "${QUICK_MODE:-0}" != "1" ]; then
    echo -e "${GREEN}âœ“ Commit is allowed to proceed.${NC}"
fi
echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}\n"

exit 0
